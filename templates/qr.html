<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escanea este QR</title>
  <style>
    body { 
      text-align: center; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 2rem; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      max-width: 450px;
      margin: 0 auto;
      border: 1px solid rgba(255,255,255,0.2);
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 1rem;
      font-size: 1.8em;
      font-weight: 600;
    }
    #countdown { 
      font-size: 2em; 
      margin-bottom: 1.5rem; 
      color: #27ae60;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    #qr-img { 
      max-width: 100%; 
      height: auto; 
      border: 4px solid #34495e; 
      border-radius: 15px; 
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    #qr-img.updating {
      opacity: 0.7;
      transform: scale(0.98);
      filter: blur(1px);
    }
    .status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .status.active {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffeaa7;
    }
    .status.updating {
      background: #cce5ff;
      color: #0066cc;
      border: 2px solid #99ccff;
    }
    .status.sync {
      background: #e7f3ff;
      color: #0056b3;
      border: 2px solid #b3d9ff;
    }
    .datetime {
      margin-top: 1.5rem;
      padding: 1.2rem;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      border: 2px solid #3498db;
      color: white;
    }
    .date-display {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #3498db;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .time-display {
      font-size: 3em;
      font-weight: bold;
      color: #ecf0f1;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>🔒 QR de Timbrado MMQEP</h2>
    <div id="countdown">Cargando...</div>
    <img id="qr-img"
         src="{{ url_for('qr_image') }}?b={{ bust }}"
         alt="QR actual">
    
    <div id="status" class="status active">
      ✅ QR Activo - Listo para escanear
    </div>
    
    
    <div id="datetime" class="datetime">
      <div id="date-display" class="date-display">Cargando fecha...</div>
      <div id="time-display" class="time-display">Cargando hora...</div>
    </div>
  </div>

  <script>
    const countdownEl = document.getElementById('countdown');
    const qrImg = document.getElementById('qr-img');
    const statusEl = document.getElementById('status');
    const dateDisplay = document.getElementById('date-display');
    const timeDisplay = document.getElementById('time-display');
    const baseQR = "{{ url_for('qr_image') }}";
    
    let refreshTimer = null;
    let countdownTimer = null;
    let datetimeTimer = null;

    // Actualizar fecha y hora en tiempo real
    function updateDateTime() {
      const now = new Date();
      
      // Formatear fecha
      const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      const dateStr = now.toLocaleDateString('es-EC', dateOptions);
      
      // Formatear hora
      const timeStr = now.toLocaleTimeString('es-EC', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      
      dateDisplay.innerText = dateStr;
      timeDisplay.innerText = timeStr;
    }

    // Cálculo local para próximo bucket de 10 segundos
    function msUntilNextBucket() {
      const now = new Date();
      const sec = now.getSeconds();
      const ms = now.getMilliseconds();
      const rem = 10 - (sec % 10);
      return rem * 1000 - ms;
    }

    // Actualizar countdown
    function updateCountdown() {
      const now = new Date();
      const sec = now.getSeconds();
      const rem = 10 - (sec % 10);
      
      countdownEl.innerText = `Nuevo QR en ${rem}s`;
      
      // Estados visuales
      if (rem <= 1) {
        statusEl.className = 'status warning';
        statusEl.innerHTML = '⚠️ QR expirando...';
      } else if (qrImg.classList.contains('updating')) {
        statusEl.className = 'status updating';
        statusEl.innerHTML = '🔄 Actualizando QR...';
      } else if (rem <= 3) {
        statusEl.className = 'status sync';
        statusEl.innerHTML = '🔄 Preparando nuevo QR...';
      } else {
        statusEl.className = 'status active';
        statusEl.innerHTML = '✅ QR Activo - Listo para escanear';
      }
    }

    // Actualizar imagen del QR
    function refreshQR() {
      console.log('🔄 Refrescando QR...');
      
      // Efecto visual de actualización
      qrImg.classList.add('updating');
      statusEl.className = 'status updating';
      statusEl.innerHTML = '🔄 Generando nuevo QR...';
      
      // URL con timestamp único para evitar cache
      const newSrc = baseQR + '?b=' + Date.now() + '&r=' + Math.random();
      
      // Precargar nueva imagen
      const newImg = new Image();
      newImg.onload = function() {
        qrImg.src = newSrc;
        qrImg.classList.remove('updating');
        console.log('✅ QR actualizado exitosamente');
        
        // Programar próxima actualización
        scheduleNextRefresh();
      };
      newImg.onerror = function() {
        console.error('❌ Error cargando nuevo QR');
        qrImg.classList.remove('updating');
        statusEl.className = 'status warning';
        statusEl.innerHTML = '⚠️ Error actualizando QR';
        
        // Reintentar en 5 segundos
        setTimeout(() => scheduleNextRefresh(), 5000);
      };
      
      newImg.src = newSrc;
    }

    // Programar próxima actualización
    function scheduleNextRefresh() {
      if (refreshTimer) {
        clearTimeout(refreshTimer);
      }
      
      const msToWait = msUntilNextBucket();
      console.log(`⏰ Próxima actualización en ${msToWait}ms`);
      
      refreshTimer = setTimeout(() => {
        refreshQR();
      }, msToWait);
    }

    // Inicializar sistema
    function initializeSystem() {
      console.log('🚀 Inicializando sistema de QR...');
      
      // Iniciar fecha y hora
      updateDateTime();
      datetimeTimer = setInterval(updateDateTime, 1000);
      
      // Iniciar countdown
      updateCountdown();
      countdownTimer = setInterval(updateCountdown, 100);
      
      // Programar primera actualización
      scheduleNextRefresh();
      
      console.log('✅ Sistema inicializado');
    }

    // Event listeners
    qrImg.addEventListener('load', () => {
      console.log('🖼️ QR cargado exitosamente');
    });

    qrImg.addEventListener('error', () => {
      console.error('❌ Error cargando QR');
      statusEl.className = 'status warning';
      statusEl.innerHTML = '⚠️ Error cargando QR';
    });

    // Limpiar timers al salir
    window.addEventListener('beforeunload', () => {
      if (refreshTimer) clearTimeout(refreshTimer);
      if (countdownTimer) clearInterval(countdownTimer);
      if (datetimeTimer) clearInterval(datetimeTimer);
    });

    // Inicializar cuando la página esté lista
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSystem);
    } else {
      initializeSystem();
    }
  </script>
</body>
</html>