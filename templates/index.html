<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registro de Ingreso</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      background: url("static/fondo.jpg") no-repeat center center fixed;
      background-size: cover;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 95%;
      width: 420px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 1.8em;
      font-weight: 600;
    }
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #34495e;
    }
    input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 1.1em;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
    }
    input.valid {
      border-color: #27ae60;
    }
    input.invalid {
      border-color: #e74c3c;
    }
    .btn {
      padding: 15px 25px;
      font-size: 1.1em;
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      min-width: 200px;
      font-weight: 500;
    }
    .btn:hover:not(:disabled) {
      background: linear-gradient(45deg, #229954, #27ae60);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
    }
    .btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    .btn.stop {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }
    .btn.stop:hover {
      background: linear-gradient(45deg, #c0392b, #a93226);
    }
    #reader {
      margin-top: 25px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
    }
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: 500;
      display: none;
      animation: slideIn 0.3s ease;
      text-align: left;
    }
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    .status-message.info {
      background: #cce5ff;
      color: #0066cc;
      border: 2px solid #99ccff;
    }
    .status-message.warning {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffeaa7;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .instructions {
      background: #e8f4fd;
      border: 1px solid #bee5eb;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 0.9em;
      color: #0c5460;
      text-align: left;
    }
    .security-note {
      background: #f8f4e6;
      border: 1px solid #f0e68c;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
      font-size: 0.85em;
      color: #8b7355;
      text-align: left;
    }
    .validation-message {
      margin-top: 5px;
      font-size: 0.85em;
      transition: all 0.3s ease;
    }
    .validation-message.valid {
      color: #27ae60;
    }
    .validation-message.invalid {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã Registro de Asistencia</h2>
    
    <div class="instructions">
      üí° <strong>Instrucciones:</strong><br>
      1. Ingrese su c√©dula de identidad (10 d√≠gitos)<br>
      2. Presione "Escanear QR" para activar la c√°mara<br>
      3. Apunte la c√°mara al c√≥digo QR de la pantalla<br>
      4. El registro se procesar√° autom√°ticamente
    </div>
    
    <div class="input-group">
      <label for="cedula">N√∫mero de C√©dula:</label>
      <input type="text" 
             id="cedula" 
             placeholder="Ej: 1234567890" 
             maxlength="10"
             pattern="[0-9]{10}">
      <div id="validation-message" class="validation-message"></div>
    </div>
    
    <button id="scan-btn" class="btn" onclick="iniciarEscaneo()">
      üì∑ Escanear C√≥digo QR
    </button>
    
    <button id="stop-btn" class="btn stop" onclick="detenerEscaneo()" style="display: none;">
      ‚èπÔ∏è Detener Escaneo
    </button>
    
    <div id="status-message" class="status-message"></div>
    
    <div id="reader" style="display:none;"></div>
    
    <div class="security-note">
      üõ°Ô∏è <strong>Nota de Seguridad:</strong> El c√≥digo QR cambia cada 10 segundos por seguridad. 
      No se permiten capturas de pantalla. Debe escanear el QR en tiempo real.
    </div>
  </div>

  <script>
    let html5QrCode = null;
    let isScanning = false;
    let processingRegistration = false;

    const cedulaInput = document.getElementById("cedula");
    const scanBtn = document.getElementById("scan-btn");
    const stopBtn = document.getElementById("stop-btn");
    const statusMessage = document.getElementById("status-message");
    const validationMessage = document.getElementById("validation-message");
    const readerEl = document.getElementById("reader");

    // ‚≠ê VALIDACI√ìN EN TIEMPO REAL DE C√âDULA
    cedulaInput.addEventListener('input', function() {
      let value = this.value.replace(/[^0-9]/g, '');
      this.value = value;
      
      validateCedula(value);
      updateScanButton();
    });

    function validateCedula(cedula) {
      if (cedula.length === 0) {
        cedulaInput.className = '';
        validationMessage.textContent = '';
        validationMessage.className = 'validation-message';
      } else if (cedula.length < 10) {
        cedulaInput.className = 'invalid';
        validationMessage.textContent = `‚ö†Ô∏è Faltan ${10 - cedula.length} d√≠gitos`;
        validationMessage.className = 'validation-message invalid';
      } else if (cedula.length === 10) {
        cedulaInput.className = 'valid';
        validationMessage.textContent = '‚úÖ C√©dula v√°lida';
        validationMessage.className = 'validation-message valid';
      }
    }

    function updateScanButton() {
      const cedula = cedulaInput.value.trim();
      scanBtn.disabled = cedula.length !== 10 || isScanning || processingRegistration;
    }

    // ‚≠ê SISTEMA DE MENSAJES MEJORADO
    function mostrarMensaje(mensaje, tipo = 'info', autoHide = false) {
      statusMessage.innerHTML = mensaje;
      statusMessage.className = `status-message ${tipo}`;
      statusMessage.style.display = 'block';
      
      if (autoHide) {
        setTimeout(() => {
          ocultarMensaje();
        }, 5000);
      }
    }

    function ocultarMensaje() {
      statusMessage.style.display = 'none';
    }

    // ‚≠ê FUNCI√ìN DE REGISTRO CON MANEJO ROBUSTO DE ERRORES
    async function registrarIngreso(cedula, token) {
      if (processingRegistration) {
        console.log('‚ö†Ô∏è Registro ya en proceso, ignorando...');
        return;
      }

      processingRegistration = true;
      mostrarMensaje('üì° Enviando registro...<span class="loading"></span>', 'info');
      
      try {
        const response = await fetch('/registrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cedula, token })
        });

        console.log('üõ∞Ô∏è Status respuesta:', response.status);
        const contentType = response.headers.get('content-type');
        console.log('üõ∞Ô∏è Content-Type:', contentType);

        const responseText = await response.text();
        console.log('üõ∞Ô∏è Respuesta completa:', responseText);

        if (contentType?.includes('application/json')) {
          const data = JSON.parse(responseText);
          
          if (response.ok && data.status === 'ok') {
            mostrarMensaje('‚úÖ <strong>¬°Registro exitoso!</strong><br>Su asistencia ha sido confirmada.', 'success', true);
            
            // Limpiar formulario para pr√≥ximo usuario
            cedulaInput.value = '';
            validateCedula('');
            updateScanButton();
            
            // Re-enfocar en c√©dula despu√©s de unos segundos
            setTimeout(() => {
              cedulaInput.focus();
            }, 2000);
            
          } else {
            const errorMsg = data.msg || 'Error desconocido al registrar';
            
            if (errorMsg.includes('inv√°lido') || errorMsg.includes('expirado')) {
              mostrarMensaje(`‚ùå <strong>QR inv√°lido o expirado</strong><br>
                üîÑ El c√≥digo QR cambi√≥ durante el escaneo.<br>
                üí° <strong>Soluci√≥n:</strong> Escanee nuevamente el QR actual.`, 'warning');
            } else if (errorMsg.includes('incompletos')) {
              mostrarMensaje('‚ùå <strong>Datos incompletos</strong><br>Verifique su c√©dula e intente nuevamente.', 'error');
            } else {
              mostrarMensaje(`‚ùå <strong>Error:</strong> ${errorMsg}`, 'error');
            }
          }
        } else {
          mostrarMensaje('‚ùå <strong>Error de comunicaci√≥n</strong><br>El servidor no respondi√≥ correctamente.', 'error');
          console.error('Respuesta no JSON:', responseText.substring(0,300));
        }
        
      } catch (error) {
        console.error('Error de red completo:', error);
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          mostrarMensaje('‚ùå <strong>Sin conexi√≥n</strong><br>Verifique su conexi√≥n a internet e intente nuevamente.', 'error');
        } else {
          mostrarMensaje(`‚ùå <strong>Error de conexi√≥n:</strong><br>${error.message}`, 'error');
        }
      } finally {
        processingRegistration = false;
        updateScanButton();
      }
    }

    // ‚≠ê FUNCI√ìN DE ESCANEO MEJORADA CON VALIDACIONES
    async function iniciarEscaneo() {
      const cedula = cedulaInput.value.trim();
      
      // Validaciones previas
      if (cedula.length !== 10) {
        mostrarMensaje('‚ö†Ô∏è <strong>C√©dula inv√°lida</strong><br>Debe ingresar exactamente 10 d√≠gitos.', 'error');
        cedulaInput.focus();
        return;
      }

      if (isScanning) {
        mostrarMensaje('‚ö†Ô∏è Ya hay un escaneo en proceso.', 'warning');
        return;
      }

      if (processingRegistration) {
        mostrarMensaje('‚ö†Ô∏è Procesando registro anterior, espere...', 'warning');
        return;
      }

      try {
        mostrarMensaje('üì∑ Iniciando c√°mara...<span class="loading"></span>', 'info');
        
        // Actualizar UI
        readerEl.style.display = "block";
        scanBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        isScanning = true;
        updateScanButton();

        // Inicializar scanner
        html5QrCode = new Html5Qrcode("reader");
        
        await html5QrCode.start(
          { facingMode: "environment" },
          { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
          },
          async (qrCodeMessage) => {
            console.log('üì± QR detectado:', qrCodeMessage.substring(0, 30) + '...');
            mostrarMensaje('üîç <strong>QR detectado</strong><br>Procesando registro...', 'info');
            
            // Detener scanner inmediatamente para evitar m√∫ltiples lecturas
            await detenerEscaneo();
            
            // Procesar el registro
            await registrarIngreso(cedula, qrCodeMessage);
          },
          (errorMessage) => {
            // Errores de escaneo continuo son normales, no mostrar
            console.debug("Escaneando...", errorMessage);
          }
        );
        
        mostrarMensaje('üì± <strong>C√°mara activa</strong><br>Apunte al c√≥digo QR para escanear.<br><em>Presione "Detener" para cancelar.</em>', 'info');
        
      } catch (error) {
        console.error('Error al iniciar scanner:', error);
        
        let errorMsg = 'Error desconocido al acceder a la c√°mara';
        if (error.message.includes('Permission')) {
          errorMsg = 'Permiso de c√°mara denegado. Habilite el acceso a la c√°mara en su navegador.';
        } else if (error.message.includes('NotFoundError')) {
          errorMsg = 'No se encontr√≥ c√°mara disponible. Verifique que su dispositivo tenga c√°mara.';
        } else if (error.message.includes('NotSupportedError')) {
          errorMsg = 'El navegador no soporta el acceso a la c√°mara o la conexi√≥n no es segura (HTTPS).';
        }
        
        mostrarMensaje(`‚ùå <strong>Error de c√°mara:</strong><br>${errorMsg}`, 'error');
        await detenerEscaneo();
      }
    }

    // ‚≠ê FUNCI√ìN PARA DETENER ESCANEO
    async function detenerEscaneo() {
      if (html5QrCode && isScanning) {
        try {
          await html5QrCode.stop();
          console.log('üì∑ Scanner detenido correctamente');
        } catch (error) {
          console.error('Error al detener scanner:', error);
        }
      }
      
      // Resetear UI
      html5QrCode = null;
      isScanning = false;
      readerEl.style.display = "none";
      readerEl.innerHTML = "";
      scanBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      
      updateScanButton();
      
      // Si no hay mensaje visible, ocultar el √°rea de mensajes
      if (statusMessage.style.display === 'block' && 
          (statusMessage.textContent.includes('C√°mara activa') || 
           statusMessage.textContent.includes('Iniciando c√°mara'))) {
        ocultarMensaje();
      }
    }

    // ‚≠ê EVENTOS ADICIONALES
    
    // Enter para iniciar escaneo
    cedulaInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && this.value.length === 10 && !isScanning && !processingRegistration) {
        iniciarEscaneo();
      }
    });

    // Auto-focus en c√©dula al hacer clic en cualquier parte
    document.addEventListener('click', function(e) {
      if (!isScanning && e.target !== cedulaInput && !cedulaInput.value) {
        cedulaInput.focus();
      }
    });

    // Limpiar al salir de la p√°gina
    window.addEventListener('beforeunload', async () => {
      await detenerEscaneo();
    });

    // ‚≠ê INICIALIZACI√ìN
    document.addEventListener('DOMContentLoaded', () => {
      updateScanButton();
      cedulaInput.focus();
      
      console.log('‚úÖ Sistema de registro inicializado');
      console.log('üîí Modo seguro: QR v√°lido solo por 10 segundos');
    });
  </script>
</body>
</html>